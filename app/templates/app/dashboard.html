{% extends "app/main.html" %}

{% block main %}
    <div class="container mx-auto px-6 py-10 space-y-10">

        <!-- Dashboard heading and user info -->
        <section class="flex flex-col md:flex-row md:items-center md:justify-between mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-600 dark:text-indigo-400 mb-4 md:mb-0">
                Dashboard
            </h1>

            <div class="bg-base-100 rounded-xl shadow-md p-6 max-w-md w-full">
                <h2 class="text-2xl font-semibold mb-2">Welcome, {{ user.get_full_name }}</h2>
                <p class="text-gray-700 dark:text-gray-300 mb-1">
                    Organisation: <span class="font-medium">{{ user.organisation.name }}</span>
                </p>
                <p class="text-gray-600 dark:text-gray-400">
                    Email: <span class="font-medium">{{ user.email }}</span>
                </p>
            </div>
        </section>

        <!-- Tax Provider Section -->
        <section class="mb-10">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3">
                <h3 class="text-xl font-semibold whitespace-nowrap">Tax Provider</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 max-w-[300px] mt-2 md:mt-0 md:ml-6 truncate"
                   title="The tax authority responsible for managing your fiscal compliance.">
                    The tax authority responsible for managing your fiscal compliance.
                </p>
            </div>
            <hr class="border-t border-gray-300 dark:border-gray-700 mb-6"/>

            {% if user.organisation.connectedtax %}
                <table class="table table-zebra w-full mb-10">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Organisation</th>
                        <th>Country</th>
                        <th>Connected</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>{{ user.organisation.connectedtax.connector.name }}</td>
                        <td>{{ user.organisation.name }}</td>
                        <td>{{ user.organisation.connectedtax.connector.tax.country.name }}</td>
                        {% if user.organisation.connectedtax.status %}
                            <td><span class="badge badge-success">Connected</span></td>
                        {% else %}
                            <td><span class="badge badge-warning">Pending Approval</span></td>
                        {% endif %}
                        <td class="space-x-2">
                            {% if not user.organisation.connectedtax.status %}
                                <a class="btn btn-sm btn-success"
                                   href="/complete-tax-provider?connected_tax={{ user.organisation.connectedtax.id }}">
                                    <i class="fa fa-check-circle mr-1"></i> Complete
                                </a>
                            {% endif %}
                            <a class="btn btn-sm btn-info"
                               href="/tax-provider-config/{{ user.organisation.connectedtax.id }}/">
                                <i class="fa fa-eye mr-1"></i> View Details
                            </a>
                            <a class="btn btn-sm btn-error"
                               href="/remove-tax-provider?connected_tax={{ user.organisation.connectedtax.id }}">
                                <i class="fa fa-times-circle mr-1"></i> Unsubscribe
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            {% else %}
                <p>No tax provider</p>
                <form action="/add-tax-provider" method="post"
                      class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 max-w-md">
                    {% csrf_token %}
                    <select name="tax_provider" class="select select-bordered w-full sm:w-auto">
                        {% for tax_provider in tax_providers %}
                            <option value="{{ tax_provider.id }}">{{ tax_provider.tax.name }}</option>
                        {% endfor %}
                    </select>
                    <input type="submit" class="btn btn-primary" value="Add tax provider"/>
                </form>
            {% endif %}
        </section>

        <!-- Connected Apps Section -->
        <section class="mb-10">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3">
                <h3 class="text-xl font-semibold whitespace-nowrap">Connected Apps</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 max-w-[300px] mt-2 md:mt-0 md:ml-6 truncate"
                   title="Point of sale software, accounting software, and ERPs connected to TaxMan.">
                    Point of sale software, accounting software, and ERPs connected to TaxMan.
                </p>
            </div>
            <hr class="border-t border-gray-300 dark:border-gray-700 mb-6"/>

            {% if connected_apps %}
                <table class="table table-zebra w-full mb-10">
                    <thead>
                    <tr>
                        <th>Platform</th>
                        <th>Version</th>
                        <th>Connection To</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for app in connected_apps %}
                        <tr>
                            <td>{{ app.connector.name }}</td>
                            <td>{{ app.connector.app }}</td>
                            <td>{{ app.organisation.name }}</td>
                            {% if app.status %}
                                <td><span class="badge badge-success">Connected</span></td>
                            {% else %}
                                <td><span class="badge badge-error">Disconnected</span></td>
                            {% endif %}
                            <td>
                                {% if app.status %}
                                    <a class="btn btn-sm btn-error" href="/disconnect-app/{{ app.id }}">
                                        <i class="fa fa-unlink mr-1"></i> Disconnect
                                    </a>
                                {% else %}
                                    <a class="btn btn-sm btn-success" href="/reconnect-app/{{ app.id }}">
                                        <i class="fa fa-plug mr-1"></i> Reconnect
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No connected apps</p>
            {% endif %}
        </section>

        <!-- Connectors Section -->
        <section class="mb-10">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3">
                <h3 class="text-xl font-semibold whitespace-nowrap">Connectors</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 max-w-[300px] mt-2 md:mt-0 md:ml-6 truncate"
                   title="Connectors are the apps that you can link with.">
                    Connectors are the apps that you can link with.
                </p>
            </div>
            <hr class="border-t border-gray-300 dark:border-gray-700 mb-6"/>

            {% if connectors %}
                <table class="table table-zebra w-full mb-10">
                    <thead>
                    <tr>
                        <th>Platform</th>
                        <th>Version</th>
                        <th>Connection Type</th>
                        <th>Connected Apps</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for connector in connectors %}
                        <tr>
                            <td>{{ connector.name }}</td>
                            <td>{{ connector.app }}</td>
                            <td>{{ connector.app.connection_type }}</td>
                            <td>{{ connector.user_connected_apps_count }}</td>
                            <td>
                                {% if organisation.connectedtax %}
                                    <a class="btn btn-sm btn-primary"
                                       href="/{{ connector.app.name }}/set-connector?connector={{ connector.id }}">
                                        {% if connector.user_connected_apps_count > 0 %}
                                            <i class="fa fa-plus-circle mr-1"></i> Connect Another
                                        {% else %}
                                            <i class="fa fa-link mr-1"></i> Connect
                                        {% endif %}
                                    </a>
                                {% else %}
                                    <button class="btn btn-sm btn-disabled" disabled>
                                        Connectors require a tax provider
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>You are connected to all of them!</p>
            {% endif %}
        </section>

        <!-- Transactions Section -->
        <section class="mb-10">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-3">
                <h3 class="text-xl font-semibold whitespace-nowrap">Transactions</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 max-w-[300px] mt-2 md:mt-0 md:ml-6 truncate"
                   title="Transactions are receipts and invoices captured from the connected systems.">
                    Transactions are receipts and invoices captured from the connected systems.
                </p>
            </div>
            <hr class="border-t border-gray-300 dark:border-gray-700 mb-6"/>

            {% if transactions %}
                <table class="table table-zebra w-full">
                    <thead>
                    <tr>
                        <th>Invoice</th>
                        <th>Amount</th>
                        <th>Currency</th>
                        <th>Platform</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.invoice_number }}</td>
                            <td>{{ transaction.total }}</td>
                            <td>{{ transaction.currency.symbol }}</td>
                            <td>{{ transaction.connected_app.connector.name }}</td>
                            <td>{{ transaction.type }}</td>
                            <td>{{ transaction.status }}</td>
                            <td>{{ transaction.date }}</td>
                            <td class="space-x-2">
                                <a class="btn btn-sm btn-info" href="/view-invoice?invoice={{ transaction.id }}">
                                    <i class="fa fa-eye mr-1"></i> Details
                                </a>
                                {% if transaction.status == 'pending' %}
                                    <a class="btn btn-sm btn-success"
                                       href="/sync-invoices?invoice={{ transaction.id }}">
                                        <i class="fa fa-refresh mr-1"></i> Fiscalise
                                    </a>
                                {% endif %}
                                {% if transaction.status == 'submitted' %}
                                    <button class="btn btn-sm btn-disabled" disabled>
                                            Automatic retry enabled
                                    </button>
                                {% endif %}
                                {% if transaction.failure_reason %}
                                    <span class="pl-2 text-error">{{ transaction.failure_reason }}</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No transactions just yet</p>
            {% endif %}
        </section>

    </div>
{% endblock %}
